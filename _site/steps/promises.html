<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Clean Code</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/steps/promises.html">

  <script>
  WebFontConfig = {
    google: {
      families: ['Source Sans Pro:400,700']
    }
  };
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js" async></script>
</head>


  <body>

    <header class="site-header">
  <nav class="site-nav">
    <a href="/" class="logo"><img src="/img/codex-logo.png" alt="codeX"></a>
    
    <a href="#menu" class="menu">Menu &darr;</a>
    

    
      
      <h2>Clean Code</h2>
      
    
  </nav>
</header>


    <main>
      <h1 id="promises-intro">Promises Intro</h1>

<p>Callbacks are an integral part of Node JS and you are using them on a daily basis. They can be a pain at times and can lead to code that is hard to read, especially when you have callbacks within callbacks. <a href="https://www.promisejs.org/">Promises</a> makes using callbacks easier.</p>

<p>Look at the code below that reads two files asynchronously and prints their contents to the screen:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">'try_this.md'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tryThis</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">'try_that.md'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tryThat</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tryThis</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tryThat</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>This is pretty standard Node code but it can soon become messy. Luckily there is an alternative.</p>

<h2 id="promises">Promises</h2>

<p><a href="https://www.promisejs.org/">Promises</a> makes callbacks easier to work with they are also make your code more <a href="http://stackoverflow.com/questions/2887013/what-does-composability-mean-in-context-of-functional-programming/2887024#2887024">composable</a>.</p>

<blockquote>
  <p>A promise represents the eventual result of an asynchronous operation.</p>
</blockquote>

<p>There are various Promises modules we will be using. Let’s look at <a href="https://github.com/petkaantonov/bluebird">bluebird</a> first. You can install it from npm using <code class="highlighter-rouge">npm install bluebird</code></p>

<blockquote>
  <p>Promises are natively supported in the newest version of Node JS (version 4) \o/</p>
</blockquote>

<p>Here’s an example of reading files using a callback:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">'try_this.md'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Here is the same code using a Promise:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">'try_this.md'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre>
</div>

<p>This code is much easier to read! We are calling <code class="highlighter-rouge">readFile</code> with a file name, the eventual result being the content of the file or an error. There are still callbacks, but the code flow much better.</p>

<p>The code is using bluebird’s promisification support. It can automatically create <a href="https://github.com/petkaantonov/bluebird/blob/master/API.md#promisification">promises from modules</a> that follow the Node JS callback convention. We will also look at creating them manually, as we need Promises with constructor functions, which bluebird’s promisification doesn’t support.</p>

<p>Using a Promise we can create a readFile constructor/factory function that looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'read-file'</span><span class="p">);</span>

<span class="nx">readFile</span><span class="p">(</span><span class="s2">"try_this.md"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre>
</div>

<p>To create the <code class="highlighter-rouge">read-file</code> module using a Promise looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">){</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre>
</div>

<h2 id="utility-functions">Utility functions</h2>

<p>Bluebird provides lots of very useful utility functions that makes our live much more pleasant when working with asynchronous code. One such function is <code class="highlighter-rouge">join</code>: it prevents nested callbacks.</p>

<p>Reading multiple files using the join function looks like this :</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'read-file'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"try_this.md"</span><span class="p">),</span>
    <span class="nx">readFile</span><span class="p">(</span><span class="s2">"try_that.md"</span><span class="p">),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">thyThisContent</span><span class="p">,</span> <span class="nx">tryThatContent</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tryThisContent</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tryThatContent</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre>
</div>

<p>Tell me that ain’t cool! :D</p>

<h2 id="make-a-promise">Make a Promise</h2>

<p>Now get this code running locally.</p>

<p>Take a closer look at the <a href="https://github.com/petkaantonov/bluebird">bluebird Promise</a> to get a better feel of what is possible!</p>

    </main>

    <footer class="site-footer">
  <nav class="main-nav" id="menu">
    <ul>
          <li>
            <a href="/steps/testable_code.html" >Testable Code</a>
            <ul>
                <li>
                    <a href="/steps/go_refactor.html" >Go refactor</a>
                </li>
                <li>
                    <a href="/steps/refactor_to_be_testable.html" >Refactor to be testable</a>
                </li>
                <li>
                    <a href="/steps/test_db_services_using_travis.html" >Test database services using Travis</a>
                </li>
                <li>
                    <a href="/steps/better_database_connections.html" >Better database connections</a>
                </li>
            </ul>
          </li>
          <li>
              <a href="/steps/promises.html" class = "active">Promises intro</a>
          </li>
          <li>
            <a href="/steps/refactor_to_using_promises.html" >Refactor to use Promises</a>
          </li>
          <li>
            <a href="/steps/the_future.html" >The future</a>
          </li>
    </ul>
  </nav>
</footer>


  </body>

</html>
